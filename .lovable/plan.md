
# Mood Pathways — Full Integration Redesign

## What You Asked For
Remove the isolated AI question-generation pipeline from Mood Pathways. Instead:
1. Mood Pathway follow-up questions must come from the existing **Questions bank** (the same questions managed in Question Management and generated by the AI Question Generator).
2. The **AI role** is narrowed to only delivering a **short wellness recommendation** after the employee submits (this already exists as `generate-daily-tip` — it just needs to be surfaced better).
3. The `generate-mood-questions` edge function and its isolated pipeline are retired.

---

## Current Architecture (What Gets Removed)

```text
Employee taps mood
        ↓
MoodPathwayQuestions component
        ↓
Calls generate-mood-questions edge function
        ↓
AI generates questions on-the-fly using Gemini
        ↓
Shows generated questions to employee
        ↓
Employee answers → saved to mood_entries.answer_value
```

Problems with this:
- Completely isolated from the Questions bank
- Admin has no visibility into what questions are shown
- Cannot be scheduled, categorized, or managed
- High AI cost per check-in (generates fresh questions every time)
- Questions are ephemeral — not auditable

---

## New Architecture (What Gets Built)

```text
Admin creates/generates questions in Question Management
        ↓
Admin tags questions with mood_levels (e.g., "great", "struggling")
        ↓
MoodPathwaySettings becomes a question assignment panel
        ↓
Employee taps mood → system fetches published questions matching that mood_level
        ↓
Employee answers inline questions
        ↓
On submit → AI generates short 2-sentence recommendation (existing generate-daily-tip)
        ↓
Recommendation shown in AchievementOverlay
```

---

## Database Changes Required

### 1. Add `mood_levels` column to `questions` table
A question can be tagged to appear for one or more mood levels. This is a `text[]` array (Postgres array), stored as JSONB for compatibility.

```sql
ALTER TABLE public.questions 
ADD COLUMN IF NOT EXISTS mood_levels jsonb DEFAULT '[]'::jsonb;

COMMENT ON COLUMN public.questions.mood_levels IS 
'Array of mood level tags: great, good, okay, struggling, need_help. When non-empty, question appears in Mood Pathway follow-up.';
```

### 2. Update `mood_question_configs` table
Remove the `custom_prompt_context` column purpose — it will be repurposed as `ai_recommendation_context` (same column, renamed semantically in UI only, no migration needed since just the label changes).

The `is_enabled` and `enable_free_text` fields remain relevant. No destructive migration needed.

---

## Files to Create / Modify

### A. Database Migration
- Add `mood_levels jsonb DEFAULT '[]'` column to `questions` table
- Add an index for performance: `CREATE INDEX IF NOT EXISTS idx_questions_mood_levels ON public.questions USING gin(mood_levels)`

### B. New Hook — `useMoodPathwayQuestions.ts`
Replaces the edge function call. Fetches questions directly from the `questions` table filtered by mood level:
```ts
// Fetches published, active questions tagged for this mood_level
// Picks up to 2 randomly from the pool (same rotation behavior)
// Falls back gracefully if none are tagged
```

### C. Updated Component — `MoodPathwayQuestions.tsx`
- **Remove**: the `supabase.functions.invoke('generate-mood-questions', ...)` call
- **Replace with**: `useMoodPathwayQuestions(moodLevel, tenantId)` hook call
- **Keep**: the same rendering UI (RadioGroup options, free-text, skip button, theme badges)
- **Remove**: the loading skeleton that said "Personalizing your check-in..." (no AI generation delay)
- The options displayed come from `question.options` (the standard JSONB options field in the questions table)
- The bilingual question text comes from `question.text` (EN) and `question.text_ar` (AR)

### D. Redesigned Admin Page — `MoodPathwaySettings.tsx`
Completely repurposed from "AI settings" to "Question Assignment":

**New layout for each mood level card:**
- Toggle: Enable pathway questions for this mood (keep `is_enabled`)
- Toggle: Enable free-text reflection after answering (keep `enable_free_text`, extreme moods only)
- **New section**: "Linked Questions" — shows questions currently tagged for this mood with the ability to unlink them
- **New button**: "Browse Questions" — opens a dialog to filter and tag existing questions from the bank with this mood level
- **AI Context** field renamed to "AI Recommendation Hint" — used by `generate-daily-tip` not `generate-mood-questions`
- Removes all theme rotation badges and descriptions (themes were internal to the old AI pipeline)

### E. New Dialog Component — `MoodQuestionPickerDialog.tsx`
A question picker for the admin settings page:
- Shows all active questions from the `questions` table
- Filterable by category
- Each row has a checkbox to tag/untag for the selected mood level
- Saves by calling `updateQuestion` mutation to set/unset the `mood_levels` array

### F. Updated `QuestionDialog.tsx` and `QuestionTable.tsx`
Add a "Mood Levels" multi-select field to the Question create/edit form so questions can be tagged directly from Question Management without going to Mood Pathway Settings.

The field shows 5 checkboxes: Great, Good, Okay, Struggling, Need Help.

### G. Updated `AIQuestionGenerator.tsx` / ConfigPanel
When the Purpose is "Daily Check-in", add a "Mood Level Tags" multi-select so AI-generated wellness questions can also be tagged for specific moods at generation time.

### H. Retire `generate-mood-questions` edge function
- Remove the invocation from `MoodPathwayQuestions.tsx`
- The edge function file is left in place but effectively unused (soft retirement — no deletion to avoid breaking any references)
- `supabase/config.toml` entry for it remains (harmless)

### I. Localization updates — `en.json` and `ar.json`
Update `moodPathway.*` keys:
- `settingsDesc` → new description about linking questions
- `enablePathway` → "Enable Mood Follow-up Questions"
- `customContext` → "AI Recommendation Hint"
- Remove keys: `generating`, `generatingSubtext` (no more AI generation delay)
- Add new keys: `browseQuestions`, `linkedQuestions`, `noLinkedQuestions`, `taggedQuestions`

---

## Check-in Flow After Change

The `InlineDailyCheckin.tsx` renders `MoodPathwayQuestions` which now:
1. Queries `questions WHERE mood_levels @> '["great"]'` (contains the selected mood)
2. Filters to `is_active = true AND deleted_at IS NULL`
3. Picks up to 2 questions randomly from results
4. If 0 results → component returns null (graceful degradation — same as before)
5. Renders inline with the same RadioGroup UI

The AI recommendation (`generate-daily-tip`) continues to fire on submit and generates a 2-sentence tip shown in `AchievementOverlay`. No change to this flow.

---

## What Does NOT Change

| Component | Status |
|-----------|--------|
| `MoodStep.tsx` | Unchanged |
| `AchievementOverlay.tsx` | Unchanged |
| `generate-daily-tip` edge function | Unchanged — still provides AI recommendations |
| `mood_entries` table | Unchanged — answers still stored in `answer_value.pathway` |
| `mood_question_configs` table | Unchanged schema — `is_enabled` and `enable_free_text` still used |
| `InlineDailyCheckin.tsx` | Minor: remove `userId` prop from MoodPathwayQuestions (no longer needed for AI call) |
| Question RLS policies | Unchanged — employee read policy already allows published questions |
| Route `/admin/mood-pathways` | Unchanged — same route, new content |

---

## Summary of New User Experience

**Employee:** After selecting a mood, they see 1-2 curated follow-up questions chosen by their admin (or tagged during AI generation). These come from the real question bank — categorized, auditable, bilingual. Then they get an AI-written 2-sentence recommendation after submitting.

**Admin:** Goes to Question Management or AI Generator, creates questions, tags them with mood levels. Goes to Mood Pathway Settings to see which questions are linked per mood, enable/disable pathways, and adjust AI recommendation context.
